name: Lab3-LabError Handling Demo

on:
  workflow_dispatch:
    inputs:
      error_type:
        description: 'Type of error to simulate'
        type: choice
        options:
          - none
          - dependency_failure
          - test_failure
          - build_failure
        default: none
      recovery_mode:
        description: 'Recovery mode'
        type: choice
        options:
          - fail_fast
          - continue_on_error
          - retry_logic
        default: continue_on_error

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      error: ${{ steps.set.outputs.error }}
      mode: ${{ steps.set.outputs.mode }}
    steps:
      - id: set
        shell: bash
        run: |
          echo "error=${{ github.event.inputs.error_type }}" >> "$GITHUB_OUTPUT"
          echo "mode=${{ github.event.inputs.recovery_mode }}" >> "$GITHUB_OUTPUT"

  deps:
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    defaults:
      run:
        working-directory: lab3/simple-cicd-pipeline
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Simulate dep error
        shell: bash
        run: |
          if [ "${{ needs.setup.outputs.mode }}" = "fail_fast" ] && [ "${{ needs.setup.outputs.error }}" = "dependency_failure" ]; then
            exit 1
          fi
          if [ "${{ needs.setup.outputs.mode }}" = "retry_logic" ] && [ "${{ needs.setup.outputs.error }}" = "dependency_failure" ]; then
            echo "Retrying..."
            sleep 1
          fi

      - name: Install
        run: npm ci || true

  test:
    runs-on: ubuntu-latest
    needs: [setup, deps]
    continue-on-error: true
    defaults:
      run:
        working-directory: lab3/simple-cicd-pipeline
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: lab3/simple-cicd-pipeline/package-lock.json

      - name: Ensure deps
        run: npm ci || npm install

      - name: Maybe add failing test
        if: needs.setup.outputs.error == 'test_failure'
        shell: bash
        run: |
          mkdir -p tests
          cat > tests/failing.test.js <<'EOF'
          test('intentional fail', () => { expect(true).toBe(false); });
          EOF

      - name: Run tests (with recovery)
        shell: bash
        run: |
          if [ "${{ needs.setup.outputs.error }}" = "test_failure" ] && [ "${{ needs.setup.outputs.mode }}" = "retry_logic" ]; then
            npm test || (rm -f tests/failing.test.js && npm test)
          else
            npm test || echo "Tests failed (as expected)"
          fi

  build:
    runs-on: ubuntu-latest
    needs: [setup, deps, test]
    continue-on-error: true
    defaults:
      run:
        working-directory: lab3/simple-cicd-pipeline
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: lab3/simple-cicd-pipeline/package-lock.json

      - name: Ensure deps
        run: npm ci || npm install

      - name: Maybe simulate build failure
        if: needs.setup.outputs.error == 'build_failure'
        shell: bash
        run: |
          if [ "${{ needs.setup.outputs.mode }}" = "retry_logic" ]; then
            mkdir -p dist
            echo "// fallback build" > dist/app.js
          elif [ "${{ needs.setup.outputs.mode }}" = "fail_fast" ]; then
            exit 1
          else
            exit 1
          fi

      - name: Build
        if: needs.setup.outputs.error != 'build_failure' || needs.setup.outputs.mode == 'retry_logic'
        run: npm run build

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-artifacts-${{ github.run_number }}
          path: lab3/simple-cicd-pipeline/dist/
          if-no-files-found: ignore
